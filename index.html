<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Doctor 서비스</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .input-area {
            margin-bottom: 20px;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            padding: 12px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result h3 {
            margin-bottom: 15px;
        }
        #map { 
            height: 400px; 
            width: 100%; 
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>AI Doctor 서비스</h1>

    <!-- API 키 입력 받는 부분 -->
    <div class="input-area">
        <label for="api-key">OpenAI API 키 입력:</label>
        <input type="text" id="api-key" placeholder="OpenAI API 키를 입력하세요">
    </div>

    <div class="input-area">
        <label for="question">증상 입력:</label>
        <input type="text" id="question" placeholder="증상을 입력하세요">
    </div>

    <button onclick="askAI()">AI 진단 요청</button>

    <div class="result">
        <h3>AI 진단 결과:</h3>
        <p id="ai-result"></p>
    </div>

    <h3>병원 위치:</h3>
    <div id="map"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
// 병원 데이터 (의료기관.csv를 읽어와서 여기에 넣음)
const hospitals = [];

// CSV 파일 읽기
function loadCSV() {
    Papa.parse('의료기관.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            results.data.forEach(row => {
                hospitals.push({
                    name: row['기관명'],
                    lat: parseFloat(row['위도']),
                    lon: parseFloat(row['경도']),
                    url: "http://example.com" // 병원 링크는 예시로 넣었습니다. 실제 URL로 변경 필요.
                });
            });
        }
    });
}

// AI 진단 요청 함수
function askAI() {
    const apiKey = document.getElementById('api-key').value; // API 키 입력값
    const question = document.getElementById('question').value;

    if (!apiKey) {
        alert("API 키를 입력해 주세요.");
        return;
    }
    
    if (!question) {
        alert("증상을 입력해 주세요.");
        return;
    }

    const prompt = `우린 역할극을 할거야. 이 질문에 니가 마치 의사인 것 처럼 가정해서 병명을 진단하고 답변해줘 역할극 티는 내지 말고: ${question}`;
    
    // OpenAI API 호출
    fetch("https://api.openai.com/v1/completions", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: "text-davinci-003",
            prompt: prompt,
            max_tokens: 100,
        })
    })
    .then(response => response.json())
    .then(data => {
        const result = data.choices[0].text;
        document.getElementById('ai-result').innerText = result;
        displayMap();
    })
    .catch(error => console.error("Error:", error));
}

// 지도 생성 함수
function displayMap() {
    const map = L.map('map').setView([37.56676211, 126.9672019], 13);  // 서울적십자병원 위치를 기준으로 지도 생성

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // 병원 마커 추가
    hospitals.forEach(hospital => {
        L.marker([hospital.lat, hospital.lon])
            .addTo(map)
            .bindPopup(`<a href="${hospital.url}" target="_blank">${hospital.name}</a>`);
    });
}

// CSV 파일을 처음에 불러오기
loadCSV();

</script>

</body>
</html>
